<?xml version="1.0" encoding="UTF-8"?>
<!--

    MOTECH PLATFORM OPENSOURCE LICENSE AGREEMENT

    Copyright (c) 2010 The Trustees of Columbia University in the City of
    New York and Grameen Foundation USA.  All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are met:

    1. Redistributions of source code must retain the above copyright notice,
    this list of conditions and the following disclaimer.

    2. Redistributions in binary form must reproduce the above copyright notice,
    this list of conditions and the following disclaimer in the documentation
    and/or other materials provided with the distribution.

    3. Neither the name of Grameen Foundation USA, Columbia University, or
    their respective contributors may be used to endorse or promote products
    derived from this software without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY GRAMEEN FOUNDATION USA, COLUMBIA UNIVERSITY
    AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
    BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
    FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL GRAMEEN FOUNDATION
    USA, COLUMBIA UNIVERSITY OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
    INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
    OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
    NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
    EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->

<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
	<help>
		USE:
			The diffs are ordered by datamodel version number.
			The script can be run in a top down fashion and is
			expected to not failor overwrite old data
		
		EXPECT:
			- "use business-database-name;" was called prior to
			   calling this script
	</help>
	
	<diff>
		<version>0.2.5</version>
		<author>Matthew Blanchette</author>
		<date>November 1 2010</date>
		<description>
			Adding scheduler tasks used in Motech.
		</description>
		<sql>
			INSERT INTO 
			scheduler_task_config 
 			(name,description,schedulable_class,start_time,repeat_interval,start_on_startup,started,created_by,date_created) VALUES
			('Immediate Notification Task','Task to send out immediate SMS notifications',
				'org.motechproject.server.omod.tasks.NotificationTask', 
				'2010-08-17 06:29:20', 300, 1, 0, 1, NOW()),
			('Daily Notification Task','Task to send out SMS notifications for next day',
				'org.motechproject.server.omod.tasks.NotificationTask', 
				'2010-08-17 23:00:00', 86400, 1, 0, 1, NOW()),
			('MessageProgram Update Task','Task to update message program state for patients',
				'org.motechproject.server.omod.tasks.MessageProgramUpdateTask', 
				'2010-08-17 06:31:40', 180, 1, 0, 1, NOW()),
			('Daily Nurse Care Messaging Task','Task to send out staff SMS care messages for day',
				'org.motechproject.server.omod.tasks.StaffCareMessagingTask', 
				'2010-08-17 23:20:00', 86400, 0, 0, 1, NOW()),
			('Weekly Nurse Care Messaging Task','Task to send out staff SMS care messages for week',
				'org.motechproject.server.omod.tasks.StaffCareMessagingTask', 
				'2010-08-15 23:40:00', 604800, 0, 0, 1, NOW());

			INSERT INTO
			scheduler_task_config_property
			(name,value,task_config_id) VALUES
			('sendImmediate', 'true', 
				(select task_config_id from scheduler_task_config where name = 'Immediate Notification Task')),
			('timeOffset', '3600', 
				(select task_config_id from scheduler_task_config where name = 'Daily Notification Task')),
			('batchSize', '35', 
				(select task_config_id from scheduler_task_config where name = 'MessageProgram Update Task')),
			('careGroups', 'PNC(mother),PNC(baby)', 
				(select task_config_id from scheduler_task_config where name = 'Daily Nurse Care Messaging Task')),
			('deliveryTime', '08:00', 
				(select task_config_id from scheduler_task_config where name = 'Daily Nurse Care Messaging Task')),
			('sendUpcoming', 'true', 
				(select task_config_id from scheduler_task_config where name = 'Daily Nurse Care Messaging Task')),
			('careGroups', 'ANC,TT,IPT,BCG,OPV,Penta,YellowFever,Measles,IPTI,VitaA', 
				(select task_config_id from scheduler_task_config where name = 'Weekly Nurse Care Messaging Task')),
			('deliveryTime', '08:00', 
				(select task_config_id from scheduler_task_config where name = 'Weekly Nurse Care Messaging Task'));
		</sql>
	</diff>
	
	<diff>
		<version>0.6.0</version>
		<author>Matthew Blanchette</author>
		<date>July 1 2010</date>
		<description>
			Creating enrollment blackout, troubledphone, messaging, outpatient encounter,
			expected care, facility, and community tables.
			Inserting message definitions, facility locations, facilities, communities,
			patient id types, and idgen sequential generators.
		</description>
		<sql>	
			CREATE TABLE IF NOT EXISTS `motechmodule_enrollment` (
				`motechmodule_enrollment_id` bigint NOT NULL auto_increment,
				`person_id` int NOT NULL,
				`program_name` varchar(200) NOT NULL,
				`obs_id` int,
				`start_date` datetime,
				`end_date` datetime,
				PRIMARY KEY (`motechmodule_enrollment_id`),
				CONSTRAINT `person_id_for_person` FOREIGN KEY (`person_id`) REFERENCES `person` (`person_id`),
				CONSTRAINT `obs_id_for_obs` FOREIGN KEY (`obs_id`) REFERENCES `obs` (`obs_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_blackout` (
				`motechmodule_blackout_id` int(11) NOT NULL auto_increment,
				`start_time` time NOT NULL,
				`end_time` time NOT NULL,
				PRIMARY KEY(`motechmodule_blackout_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_troubledphone` (
				`motechmodule_tphone_id` int(11) NOT NULL auto_increment,
				`phone_number` varchar(50) NOT NULL,
				`creation_time` timestamp NOT NULL DEFAULT current_timestamp,
				`send_failures` int NOT NULL DEFAULT 1,
				PRIMARY KEY(`motechmodule_tphone_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			CREATE TABLE IF NOT EXISTS `motechmodule_messageattribute` (
				`motechmodule_messageattribute_id` bigint NOT NULL auto_increment,
				`attribute_name` varchar(255) NOT NULL UNIQUE,
				`attribute_property` varchar(255) NOT NULL,
				PRIMARY KEY (`motechmodule_messageattribute_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			CREATE TABLE IF NOT EXISTS `motechmodule_messagedefinition` (
				`motechmodule_messagedefinition_id` bigint NOT NULL auto_increment,
				`message_key` varchar(255) NOT NULL UNIQUE,
				`public_id` bigint NOT NULL UNIQUE,
				`message_type` varchar(13) NOT NULL,
				PRIMARY KEY (`motechmodule_messagedefinition_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			CREATE TABLE IF NOT EXISTS `motechmodule_messagedefinition_attribute` (
				`definition_id` bigint NOT NULL,
				`attribute_id` bigint NOT NULL,
				CONSTRAINT `definition_of_attributes` FOREIGN KEY (`definition_id`)
				REFERENCES `motechmodule_messagedefinition` (`motechmodule_messagedefinition_id`),
				CONSTRAINT `attribute_of_definitions` FOREIGN KEY (`attribute_id`)
				REFERENCES `motechmodule_messageattribute` (`motechmodule_messageattribute_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;

			CREATE TABLE IF NOT EXISTS `motechmodule_scheduledmessage` (
				`motechmodule_scheduledmessage_id` bigint NOT NULL auto_increment,
				`scheduled_for` datetime NOT NULL,
				`definition_id` bigint NOT NULL,
				`recipient_id` int NOT NULL,
				`enrollment_id` bigint NOT NULL,
				`care_name` varchar(50),
				PRIMARY KEY (`motechmodule_scheduledmessage_id`),
				CONSTRAINT `person_id_for_recipient` FOREIGN KEY (`recipient_id`) REFERENCES `person` (`person_id`),
				CONSTRAINT `definition_of_scheduledmessage` FOREIGN KEY (`definition_id`)
				REFERENCES `motechmodule_messagedefinition` (`motechmodule_messagedefinition_id`),
				CONSTRAINT `enrollment_of_scheduledmessage` FOREIGN KEY (`enrollment_id`)
				REFERENCES `motechmodule_enrollment` (`motechmodule_enrollment_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_message` (
				`motechmodule_message_id` bigint NOT NULL auto_increment,
				`public_id` varchar(36) NOT NULL UNIQUE,
				`schedule_id` bigint NOT NULL,
				`attempt_date` datetime,
				`attempt_status` varchar(15),
				PRIMARY KEY (`motechmodule_message_id`),
				CONSTRAINT `scheduledmessage_of_message` FOREIGN KEY (`schedule_id`)
				REFERENCES `motechmodule_scheduledmessage` (`motechmodule_scheduledmessage_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_generaloutpatientencounter` (
				`id` bigint NOT NULL auto_increment,
				`date` date NOT NULL,
				`staff_id` int NOT NULL,
				`facility_id` int NOT NULL,
				`serial_number` varchar(255) NOT NULL,
				`sex` varchar(6) NOT NULL,
				`birthdate` date NOT NULL,
				`insured` boolean NOT NULL,
				`newcase` boolean NOT NULL,
				`diagnosis` int NOT NULL,	
				`secondary_diagnosis` int,
				`referred` boolean NOT NULL,
				`rdt_given` boolean,
				`rdt_positive` boolean,
				`act_treated` boolean,
				`comments` varchar(200),
				PRIMARY KEY (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_expected_obs` (
				`motechmodule_expected_obs_id` bigint NOT NULL auto_increment,
				`patient_id` int NOT NULL,
				`concept_id` int NOT NULL,
				`value_coded` int,
				`value_numeric` double,
				`min_datetime` datetime,
				`due_datetime` datetime NOT NULL,
				`late_datetime` datetime NOT NULL,
				`max_datetime` datetime,
				`obs_id` int,
				`care_name` varchar(50) NOT NULL,
				`group_name` varchar(50) NOT NULL,
				`voided` boolean NOT NULL,
				PRIMARY KEY (`motechmodule_expected_obs_id`),
				CONSTRAINT `patient_of_obs` FOREIGN KEY (`patient_id`) REFERENCES `patient` (`patient_id`),
				CONSTRAINT `concept_of_obs` FOREIGN KEY (`concept_id`) REFERENCES `concept` (`concept_id`),
				CONSTRAINT `value_concept_of_obs` FOREIGN KEY (`value_coded`) REFERENCES `concept` (`concept_id`),
				CONSTRAINT `actual_obs` FOREIGN KEY (`obs_id`) REFERENCES `obs` (`obs_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_expected_encounter` (
				`motechmodule_expected_encounter_id` bigint NOT NULL auto_increment,
				`patient_id` int NOT NULL,
				`encounter_type` int NOT NULL,
				`min_datetime` datetime,
				`due_datetime` datetime NOT NULL,
				`late_datetime` datetime NOT NULL,
				`max_datetime` datetime,
				`encounter_id` int,
				`care_name` varchar(50) NOT NULL,
				`group_name` varchar(50) NOT NULL,
				`voided` boolean NOT NULL,
				PRIMARY KEY (`motechmodule_expected_encounter_id`),
				CONSTRAINT `patient_of_encounter` FOREIGN KEY (`patient_id`) REFERENCES `patient` (`patient_id`),
				CONSTRAINT `type_of_encounter` FOREIGN KEY (`encounter_type`) REFERENCES `encounter_type` (`encounter_type_id`),
				CONSTRAINT `actual_encounter` FOREIGN KEY (`encounter_id`) REFERENCES `encounter` (`encounter_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_facility` (
				`id` bigint NOT NULL auto_increment,
				`facility_id` int NOT NULL UNIQUE,
				`location_id` int(11) NOT NULL UNIQUE,
				`phone_number` varchar(50),
				PRIMARY KEY (`id`),
				CONSTRAINT `location_of_facility` FOREIGN KEY (`location_id`) REFERENCES `location` (`location_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_community` (
				`id` bigint NOT NULL auto_increment,
				`community_id` int NOT NULL UNIQUE,
				`name` varchar(50) NOT NULL,
				`facility_id` bigint,
				PRIMARY KEY (`id`),
				CONSTRAINT `facility_of_community` FOREIGN KEY (`facility_id`) REFERENCES `motechmodule_facility` (`id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
			CREATE TABLE IF NOT EXISTS `motechmodule_community_patient` (
				`community_id` bigint NOT NULL,
				`patient_id` int(11) NOT NULL UNIQUE,
				CONSTRAINT `com_pat_rel_community` FOREIGN KEY (`community_id`) REFERENCES `motechmodule_community` (`id`),
				CONSTRAINT `com_pat_rel_patient` FOREIGN KEY (`patient_id`) REFERENCES `patient` (`patient_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;		
			
		</sql>
	</diff>
	
	<diff>
		<version>1.0.0</version>
		<author>Matthew Blanchette</author>
		<date>November 18 2010</date>
		<description>
			Adding scheduler tasks used in Motech mobile.
		</description>
		<sql>
			INSERT INTO 
			scheduler_task_config 
 			(name,description,schedulable_class,start_time,repeat_interval,start_on_startup,started,created_by,date_created) VALUES
			('IVR Process Open Sessions Task','Task to process open IVR sessions',
				'org.motechproject.server.omod.tasks.IVRProcessOpenSessionsTask', 
				'2010-11-17 06:00:15', 30, 1, 0, 1, NOW()),
			('IVR Process Waiting Sessions Task','Task to process waiting IVR sessions',
				'org.motechproject.server.omod.tasks.IVRProcessWaitingSessionsTask', 
				'2010-11-17 06:00:00', 30, 1, 0, 1, NOW()),
			('Message Sending Task','Task to send scheduled messages',
				'org.motechproject.server.omod.tasks.MessageSendingTask', 
				'2010-11-17 06:00:00', 60, 1, 0, 1, NOW()),
			('Message Status Update Task','Task to update message statuses',
				'org.motechproject.server.omod.tasks.MessageStatusUpdateTask', 
				'2010-11-17 06:00:00', 60, 1, 0, 1, NOW()),
			('Message Request Processing Task','Task to process message requests',
				'org.motechproject.server.omod.tasks.MessageRequestProcessTask', 
				'2010-11-17 06:00:00', 30, 1, 0, 1, NOW()),
			('Message Response Processing Task','Task to process message responses',
				'org.motechproject.server.omod.tasks.MessageResponseProcessTask', 
				'2010-11-17 06:00:15', 180, 1, 0, 1, NOW()),
			('Message Retry Processing Task','Task to process message retries',
				'org.motechproject.server.omod.tasks.MessageRetryProcessTask', 
				'2010-11-17 06:00:00', 300, 1, 0, 1, NOW());
		</sql>
	</diff>

</sqldiff>
